<?php
/**
 * Resigned Processor â€” v1.3.0
 * Strict match policy:
 *   - Find user by EMAIL
 *   - Then verify EITHER NIC OR PASSPORT matches user's meta (nic_no OR passport_no)
 *   - If neither NIC nor Passport provided -> skip
 *
 * Actions (same as before; controlled by flags):
 *   - Deactivate user (role->inactive OR strip roles), optionally UM account_status=inactive, kill sessions
 *   - Remove from all LearnDash groups
 *   - Unenroll from all LearnDash courses (+ optional progress reset)
 *
 * Usage (spawned by launch.php):
 *   php resigned_worker.php \
 *     --csv=/path/file.csv \
 *     --matched=/srv/admin-tools/_mailer-logs/resigned_xxx/matched_done.csv \
 *     --unmatched=/srv/admin-tools/_mailer-logs/resigned_xxx/unmatched_skipped.csv \
 *     [--live] [--limit=100] [--remove-groups] [--unenroll-courses] [--reset-progress] [--um-inactive] [--strip-roles]
 *
 * CSV headers accepted (case/spacing insensitive):
 *   email:        user_email, email, user email, e-mail, primary email
 *   nic:          NIC #, nic, nic no, nic_no, nic number, national id, nric, nric no, nic#
 *   passport:     Passport, passport_no, passport no, passport number, passport #, pp no
 */

error_reporting(E_ALL); ini_set('display_errors', 1);
if (!defined('WP_DISABLE_FATAL_ERROR_HANDLER')) define('WP_DISABLE_FATAL_ERROR_HANDLER', true);
register_shutdown_function(function(){
  $e = error_get_last();
  if ($e && in_array($e['type'], [E_ERROR,E_PARSE,E_CORE_ERROR,E_COMPILE_ERROR])) {
    fwrite(STDERR, "FATAL: {$e['message']} in {$e['file']}:{$e['line']}\n");
  }
});

require('/var/www/html/wp-load.php'); // adjust if needed

// ---------- Args ----------
$argv_assoc = [];
foreach (($argv ?? []) as $a) {
  if (preg_match('/^--([^=]+)=(.*)$/', $a, $m)) $argv_assoc[$m[1]] = $m[2];
  elseif (preg_match('/^--(.+)$/', $a, $m))     $argv_assoc[$m[1]] = true;
}
$CSV      = (string)($argv_assoc['csv']      ?? '');
$MATCHED  = (string)($argv_assoc['matched']  ?? '');
$UNMATCH  = (string)($argv_assoc['unmatched']?? '');
$LIVE     = !empty($argv_assoc['live']);
$LIMIT    = isset($argv_assoc['limit']) ? max(0,(int)$argv_assoc['limit']) : 0;

// toggles (default OFF unless passed)
$DO_GROUPS   = !empty($argv_assoc['remove-groups']);       // remove from LD groups
$DO_UNENROLL = !empty($argv_assoc['unenroll-courses']);    // unenroll from LD courses
$DO_RESET    = !empty($argv_assoc['reset-progress']);      // reset LD progress
$DO_UM       = !empty($argv_assoc['um-inactive']);         // set UM account_status=inactive
$DO_STRIP    = !empty($argv_assoc['strip-roles']);         // remove all WP roles instead of switching to 'inactive'

// ---------- Helpers ----------
function detect_delimiter($line) {
  foreach ([",","\t",";"] as $d) if (count(str_getcsv($line,$d))>1) return $d;
  return ",";
}
function norm_label($s){ return strtolower(trim(preg_replace('/[^\p{L}\p{N}]+/u','',$s))); }
function build_idx_map($header){ $m=[]; foreach($header as $i=>$h){ $m[norm_label($h)]=$i; } return $m; }
function v($row,$idx){ return ($idx!==null && isset($row[$idx])) ? trim((string)$row[$idx]) : ''; }
function idx_any($idxmap, array $labels){
  foreach ($labels as $label){
    $k = norm_label($label);
    if (array_key_exists($k, $idxmap)) return $idxmap[$k];
  }
  return null;
}
function eq_norm($a,$b){
  $a = trim((string)$a); $b = trim((string)$b);
  // normalize by stripping spaces and casing
  $an = strtolower(preg_replace('/\s+/','', $a));
  $bn = strtolower(preg_replace('/\s+/','', $b));
  return ($an !== '' && $an === $bn);
}

// LearnDash course list for a user
function ld_all_user_courses($user_id){
  if (function_exists('learndash_user_get_enrolled_courses')) {
    $ids = (array)learndash_user_get_enrolled_courses($user_id);
  } elseif (function_exists('ld_get_mycourses')) {
    $ids = (array)ld_get_mycourses($user_id);
  } else { $ids = []; }
  return array_values(array_unique(array_map('intval',$ids)));
}

// ---------- Open CSV ----------
if ($CSV==='' || !is_file($CSV)) { fwrite(STDERR,"âŒ CSV not found: $CSV\n"); exit(2); }
$fh = fopen($CSV,'r'); if(!$fh){ fwrite(STDERR,"âŒ Cannot open CSV\n"); exit(2); }
$first = fgets($fh); if($first===false){ fwrite(STDERR,"âŒ Empty CSV\n"); exit(2); }
$delim  = detect_delimiter($first);
$header = str_getcsv($first,$delim);
$idxmap = build_idx_map($header);

// ---------- Identify columns (flexible) ----------
$idx_email = idx_any($idxmap, [
  'user_email','email','user email','e-mail','primary email'
]);

$idx_nic = idx_any($idxmap, [
  'NIC #','nic','nic no','nic_no','nic number','national id','nric','nric no','nic#'
]);

$idx_passport = idx_any($idxmap, [
  'Passport','passport_no','passport no','passport number','passport #','pp no'
]);

// Meta snapshot columns (same as before, for reporting only)
$meta_fields = [
  'expat_local'      => 'Expatriate/Local',
  'employment_status'=> 'Status of Employee',
  'company'          => 'Company Name',
  'division'         => 'Department',
  'date_of_birth'    => 'DOB',
  'nic_no'           => 'NIC #',
  'passport_no'      => 'Passport',
  'gender'           => 'Gender',
  'mobile_no'        => 'Mobile',
  'designation'      => 'Designation',
  'join_date'        => 'DOJ',
  'employee_number'  => 'Employee Number',
];
$meta_idx = [];
foreach ($meta_fields as $k=>$label) $meta_idx[$k] = $idxmap[norm_label($label)] ?? null;

// ---------- Output CSVs ----------
$mf  = fopen($MATCHED,'w');   $uf = fopen($UNMATCH,'w');
fputcsv($mf, array_merge(['user_login','user_email','actions'], array_keys($meta_fields), ['removed_groups','unenrolled_courses','progress_reset']));
fputcsv($uf, ['reason','user_email','NIC','Passport']);

echo "ğŸš€ Resigned Processor v1.3.0 â€” ".($LIVE?'LIVE':'DRY RUN')."\n";
echo "    Policy: email + (NIC OR Passport) must match the same user\n";
echo "    Options: groups=".($DO_GROUPS?'on':'off')." unenroll=".($DO_UNENROLL?'on':'off')." reset=".($DO_RESET?'on':'off')." UM=".($DO_UM?'on':'off')." strip_roles=".($DO_STRIP?'on':'off')."\n";

$done=0; $matched=0; $unmatched=0;

while (($row = fgetcsv($fh,0,$delim)) !== false) {
  if ($LIMIT>0 && $done>=$LIMIT) { echo "â¹ï¸ Limit {$LIMIT} reached.\n"; break; }
  if (count(array_filter($row, fn($x)=>trim((string)$x)!==''))===0) continue;

  $email    = v($row,$idx_email);
  $nic_csv  = v($row,$idx_nic);
  $pp_csv   = v($row,$idx_passport);

  // Must have email
  if ($email === '') {
    fputcsv($uf, ['Missing email','', $nic_csv, $pp_csv]);
    $unmatched++; $done++;
    continue;
  }

  // Lookup by email ONLY
  $user = get_user_by('email', $email);
  if (!$user) {
    fputcsv($uf, ['Email not found in WP', $email, $nic_csv, $pp_csv]);
    $unmatched++; $done++;
    continue;
  }

  // Must have at least NIC or Passport to verify
  if ($nic_csv === '' && $pp_csv === '') {
    fputcsv($uf, ['No NIC/Passport provided to verify', $email, $nic_csv, $pp_csv]);
    $unmatched++; $done++;
    continue;
  }

  // Fetch user meta for verification
  $uid = $user->ID;
  $nic_meta = (string)get_user_meta($uid, 'nic_no', true);
  $pp_meta  = (string)get_user_meta($uid, 'passport_no', true);

  $nic_ok = ($nic_csv !== '' && eq_norm($nic_csv, $nic_meta));
  $pp_ok  = ($pp_csv  !== '' && eq_norm($pp_csv,  $pp_meta));

  if (!($nic_ok || $pp_ok)) {
    fputcsv($uf, ['Email found, but NIC/Passport mismatch', $email, $nic_csv, $pp_csv]);
    $unmatched++; $done++;
    continue;
  }

  // ---------- VERIFIED: proceed with actions ----------
  $login=$user->user_login; $actions=[]; $removed_groups=[]; $unenrolled_courses=[]; $reset_courses=[];

  // UM account_status
  if ($DO_UM) {
    $actions[] = 'um:inactive';
    if ($LIVE) update_user_meta($uid, 'account_status', 'inactive');
  }

  // Roles: set 'inactive' or strip all
  if ($DO_STRIP) {
    $actions[] = 'roles:strip-all';
    if ($LIVE) $user->set_role('');
  } else {
    $actions[] = 'role:inactive';
    if ($LIVE) {
      if (!get_role('inactive')) { $user->set_role(''); } else { $user->set_role('inactive'); }
    }
  }

  // Kill sessions
  $actions[] = 'sessions:kill';
  if ($LIVE && class_exists('WP_Session_Tokens')) {
    $mgr = WP_Session_Tokens::get_instance($uid);
    if ($mgr) $mgr->destroy_all();
  }

  // LearnDash: remove from groups
  if ($DO_GROUPS && function_exists('learndash_get_users_group_ids')) {
    $gids = (array)learndash_get_users_group_ids($uid);
    foreach ($gids as $gid) {
      $removed_groups[] = (int)$gid;
      if ($LIVE && function_exists('ld_update_group_access')) {
        ld_update_group_access($uid, (int)$gid, 'remove');
      }
    }
    $actions[] = 'ld:groups-removed('.count($removed_groups).')';
  }

  // LearnDash: unenroll from courses (+ reset)
  if ($DO_UNENROLL && function_exists('ld_update_course_access')) {
    $cids = ld_all_user_courses($uid);
    foreach ($cids as $cid) {
      $unenrolled_courses[] = (int)$cid;
      if ($LIVE) ld_update_course_access($uid, (int)$cid, true);
      if ($DO_RESET && function_exists('learndash_delete_course_progress')) {
        if ($LIVE) learndash_delete_course_progress((int)$cid, (int)$uid);
        $reset_courses[] = (int)$cid;
      }
    }
    $actions[] = 'ld:unenrolled('.count($unenrolled_courses).')';
    if ($DO_RESET) $actions[] = 'ld:progress-reset('.count($reset_courses).')';
  }

  // Meta snapshot for reporting
  $meta_snapshot=[];
  foreach ($meta_fields as $k=>$label) $meta_snapshot[] = (string)get_user_meta($uid,$k,true);

  fputcsv($mf, array_merge([$login, $user->user_email, implode('|',$actions)], $meta_snapshot, [implode('|',$removed_groups), implode('|',$unenrolled_courses), implode('|',$reset_courses)]));
  echo ($LIVE ? "âœ… " : "ğŸ‘ï¸ PREVIEW ")."{$login} â€” ".implode(', ',$actions)."\n";
  $matched++; $done++;
}

fclose($fh); fclose($mf); fclose($uf);
echo "ğŸ“Š Summary: matched={$matched}, unmatched={$unmatched}, processed={$done}, mode=".($LIVE?'LIVE':'DRY')."\n";