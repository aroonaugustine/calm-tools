<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Resigned Processor — v1.4.1</title>
<meta name="robots" content="noindex,nofollow">
<link rel="stylesheet" href="/portal-assets/css/portal.css">
<style>
  body { margin: 0; }
  main { padding: 32px 24px; max-width: 960px; }
  .tool-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 30px; }
  .tool-card h1 { margin-bottom: 6px; }
  .muted { color: var(--muted); }
  fieldset { border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 24px; background: rgba(15,23,42,.02); }
  legend { font-weight: 700; padding: 0 8px; }
  label { display: block; margin: 10px 0; font-weight: 600; }
  input[type=text], input[type=password], input[type=number], input[type=file] { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: white; }
  input[type=radio], input[type=checkbox] { margin-right: 8px; }
  .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  button { padding: 12px 24px; border-radius: 999px; border: 1px solid var(--border); background: var(--accent); color: white; font-weight: 600; cursor: pointer; }
  button[type=button] { background: transparent; color: var(--text); }
  button:hover { background: #1d4ed8; }
  button[type=button]:hover { background: rgba(15,23,42,.05); }
  .small { font-size: 12px; }
</style>
</head>
<body>
  <main>
    <div class="tool-card">
      <h1>Resigned Processor <span class="muted">v1.4.1</span></h1>
      <p class="muted">Batch unenroll resigned staff, strip roles, and clean up LearnDash relationships in a single run.</p>
      <form method="post" action="launch.php" enctype="multipart/form-data">
    <fieldset>
      <legend>Auth</legend>
      <label>Launcher Auth Token:
        <input type="password" name="token" required>
      </label>
    </fieldset>

    <fieldset>
      <legend>CSV Source</legend>
      <label class="row"><input type="radio" name="csv_mode" value="upload" checked> Upload CSV</label>
      <input type="file" name="csv_file" accept=".csv">
      <div style="height:10px"></div>
      <label class="row"><input type="radio" name="csv_mode" value="server"> Use server path</label>
      <input type="text" name="csv_path" placeholder="/home/bulk_update/Resigned.csv">
      <div class="small muted">Tip: “Server path” avoids Cloudflare timeouts for very large files.</div>
    </fieldset>

    <fieldset>
      <legend>Matching Policy</legend>
      <label class="row"><input type="radio" name="match_mode" value="strict" checked> <b>Strict</b> — email + (NIC OR Passport) must match the same WP user</label>
      <label class="row"><input type="radio" name="match_mode" value="email"> <b>Email only</b> — match by email only</label>
      <label class="row"><input type="radio" name="match_mode" value="id"> <b>NIC/Passport only</b> — match by NIC or Passport only</label>
      <div class="small muted">Worker receives <code>--match=strict</code>, <code>--match=email</code>, or <code>--match=id</code>.</div>
    </fieldset>

    <fieldset>
      <legend>Batching (avoid 504s)</legend>
      <label>Batch size (rows per chunk, header excluded):
        <input type="number" min="0" step="1" name="batch_size" value="0">
      </label>
      <div class="small muted">0 = no batching. Try 200–1000 if you’re hitting timeouts.</div>
      <label>Delay between chunks (ms):
        <input type="number" min="0" step="50" name="batch_delay_ms" value="250">
      </label>
      <div class="small muted">Adds a small pause between chunks to reduce DB and PHP load (optional).</div>
    </fieldset>

    <fieldset>
      <legend>Options</legend>
      <label class="row"><input type="checkbox" name="live" value="1"> Live run (apply changes). Untick = DRY RUN (preview only).</label>
      <label class="row"><input type="checkbox" name="remove_groups" value="1" checked> Remove from all LearnDash groups</label>
      <label class="row"><input type="checkbox" name="unenroll_courses" value="1"> Unenroll from all LearnDash courses</label>
      <label class="row" style="margin-left:24px"><input type="checkbox" name="reset_progress" value="1"> …and reset course progress</label>
      <label class="row"><input type="checkbox" name="um_inactive" value="1"> Set Ultimate Member account_status = inactive</label>
      <label class="row"><input type="checkbox" name="strip_roles" value="1"> Strip all WordPress roles (fallback if you don’t have an “inactive” role)</label>
      <div class="row">
        <label>Limit (0 = all):
          <input type="number" name="limit" value="0" class="small">
        </label>
      </div>
    </fieldset>

    <div class="row" style="margin-top:12px">
      <button type="submit">Launch Background Run</button>
      <a href="status.php"><button type="button">View Runs & Logs</button></a>
    </div>
  </form>
    </div>
  </main>
  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var token = params.get('token');
      var fields = document.querySelectorAll('input[name="token"]');

      if (!fields.length) {
        return;
      }

    if (token) {
      fields.forEach(function(field) {
        field.value = token;
        field.type = 'hidden';
        field.required = false;
        var section = field.closest('fieldset');
        if (section) {
          section.style.display = 'none';
        } else {
          var label = field.closest('label');
          if (label) {
            label.style.display = 'none';
          }
        }
      });
        return;
      }

      fields.forEach(function(field) {
        var label = field.closest('label');
        if (!label || label.querySelector('.token-hint')) {
          return;
        }
        var hint = document.createElement('div');
        hint.className = 'token-hint';
        hint.textContent = 'Launch this tool from the CALM Admin Toolkit portal to auto-fill the access token.';
        hint.style.color = '#b91c1c';
        hint.style.fontSize = '12px';
        hint.style.marginTop = '6px';
        label.appendChild(hint);
      });
    })();
  </script>
</body>
</html>
