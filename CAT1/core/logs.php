<?php require_once __DIR__.'/bootstrap.php'; require_once __DIR__.'/ui.php'; $runs=[]; $it=new DirectoryIterator(LOG_DIR); foreach($it as $f){ if($f->isDot()||!$f->isDir())continue; $n=$f->getFilename(); $m=read_json($f->getPathname().'/run.json',[]); $runs[]=['name'=>$n,'path'=>$f->getPathname(),'meta'=>$m,'status'=>is_file($f->getPathname().'/DONE')?'DONE':(is_file($f->getPathname().'/STARTED')?'RUNNING':'UNKNOWN')]; } usort($runs,fn($a,$b)=>strcmp($b['name'],$a['name'])); $tail_id=$_GET['id']??''; $tail_txt=''; if($tail_id){ $lf=LOG_DIR.'/'.basename($tail_id).'/stdout.log'; if(is_file($lf)){ $size=filesize($lf); $max=200*1024; if($size>$max){ $fp=fopen($lf,'r'); fseek($fp,-$max,SEEK_END); $tail_txt=stream_get_contents($fp); fclose($fp);} else { $tail_txt=file_get_contents($lf);} } elseif(is_file($lf.'.gz')){ $tail_txt=gzdecode(file_get_contents($lf.'.gz')); } else { $tail_txt='No stdout.log found.'; } } echo ui_header('Logs â€” CALM Tools Hub'); $base=rtrim(dirname($_SERVER['SCRIPT_NAME']),'/'); ?><div class="container"><h1>Log Viewer</h1><div class="panel"><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left">Run ID</th><th>Status</th><th>Tool</th><th>Started</th><th>Finished</th><th>Actions</th></tr></thead><tbody><?php foreach($runs as $r): $m=$r['meta']; ?><tr style="border-top:1px solid #1f2937"><td><code><?=h($r['name']);?></code></td><td><?php if($r['status']==='DONE'): ?><span class="badge ok">DONE</span><?php elseif($r['status']==='RUNNING'): ?><span class="badge run">RUNNING</span><?php else: ?><span class="badge err">UNKNOWN</span><?php endif; ?></td><td><?=h($m['tool']??'n/a');?></td><td><?=h($m['started_utc']??'');?></td><td><?=h($m['finished_utc']??'');?></td><td><a class="btn" href="<?=$base?>/logs.php?id=<?=urlencode($r['name']);?>#tail">Tail</a><?php $arts=$m['artifacts']??[]; foreach($arts as $af){ $fn=basename($af); echo ' <a class="btn" href="'.$base.'/raw.php?id='.h($r['name']).'&file='.h($fn).'">'.h($fn).'</a>'; } if(is_file($r['path'].'/matched_done.csv'))echo ' <a class="btn" href="'.$base.'/raw.php?id='.h($r['name']).'&file=matched_done.csv">matched_done.csv</a>'; if(is_file($r['path'].'/unmatched_skipped.csv'))echo ' <a class="btn" href="'.$base.'/raw.php?id='.h($r['name']).'&file=unmatched_skipped.csv">unmatched_skipped.csv</a>'; if(is_file($r['path'].'/input.csv'))echo ' <a class="btn" href="'.$base.'/raw.php?id='.h($r['name']).'&file=input.csv">input.csv</a>'; ?></td></tr><?php endforeach; ?></tbody></table></div><h2 id="tail">Tail: <?=h($tail_id?:'(select a run)');?></h2><div id="log" class="logbox"><?=h($tail_txt);?></div></div><?=ui_footer();?>