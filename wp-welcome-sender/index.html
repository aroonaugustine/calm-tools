<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Welcome Sender — v2.6.2-web</title>
<meta name="robots" content="noindex,nofollow">
<link rel="stylesheet" href="/portal-assets/css/portal.css">
<style>
  body { margin: 0; }
  main { padding: 32px 24px; max-width: 980px; }
  .tool-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 30px; }
  fieldset { border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 22px; background: rgba(15,23,42,.02); }
  legend { font-weight: 700; padding: 0 8px; }
  label { display: block; margin: 10px 0; font-weight: 600; }
  input[type=text], input[type=password], textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: white; }
  input[type=file] { padding: 10px; border: 1px dashed var(--border); border-radius: 12px; width: 100%; cursor: pointer; background: rgba(15,23,42,.02); }
  input[type=radio], input[type=checkbox] { margin-right: 8px; }
  .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .muted { color: var(--muted); }
  .small { font-size: 12px; }
  button { padding: 12px 22px; border-radius: 999px; border: 1px solid var(--border); background: var(--accent); color: white; font-weight: 600; cursor: pointer; }
  button[type=button] { background: transparent; color: var(--text); }
  button[type=button]:hover { background: rgba(15,23,42,.05); }
  button:hover { background: #1d4ed8; }
  .pill { display: inline-flex; align-items: center; padding: 2px 10px; border: 1px solid var(--border); border-radius: 999px; font-size: 12px; color: var(--muted); }
  textarea { min-height: 120px; }
  .token-hint { color: #b91c1c; font-size: 12px; margin-top: 6px; display: block; font-weight: 400; }
</style>
<script>
  function onModeChange(val){
    document.getElementById('csv_upload_wrap').style.display = (val==='upload') ? '' : 'none';
    document.getElementById('server_path_wrap').style.display = (val==='server') ? '' : 'none';
    document.getElementById('manual_wrap').style.display      = (val==='manual') ? '' : 'none';
  }
  document.addEventListener('DOMContentLoaded', function(){
    const radios = document.querySelectorAll('input[name="csv_mode"]');
    radios.forEach(r => r.addEventListener('change', e => onModeChange(e.target.value)));
    const checked = document.querySelector('input[name="csv_mode"]:checked');
    if (checked) onModeChange(checked.value);
  });
</script>
</head>
<body>
  <main>
    <div class="tool-card">
      <h1>Welcome Sender <span class="muted">v2.6.2-web</span></h1>
      <p class="muted">
        Send the "Welcome to CALM" email to CSV uploads, server-side files, or a quick manual list. Supports username or email inputs plus optional greeting overrides.
      </p>

  <form method="post" action="launch.php" enctype="multipart/form-data">
    <fieldset>
      <legend>Auth</legend>
      <label>Launcher Auth Token
        <input type="password" name="token" placeholder="paste AUTH_TOKEN (launcher)" required>
        <span class="token-hint">Launch via the CALM Admin Toolkit portal to auto-fill the token.</span>
      </label>
    </fieldset>

    <fieldset>
      <legend>Source</legend>

      <label class="row">
        <input type="radio" name="csv_mode" value="upload" checked> Upload CSV now
        <span class="pill">Recommended</span>
      </label>
      <div id="csv_upload_wrap">
        <input type="file" name="csv_file" accept=".csv">
        <div class="small muted">
          CSV must include either <code>user_email</code>/<code>email</code> OR <code>user_login</code>/<code>username</code>/<code>login</code>.<br>
          Optional: <code>name</code>/<code>full_name</code>/<code>first_name</code> for the greeting.
        </div>
      </div>

      <div style="margin:10px 0"></div>

      <label class="row">
        <input type="radio" name="csv_mode" value="server"> Use server path
      </label>
      <div id="server_path_wrap" style="display:none">
        <input type="text" name="csv_path" placeholder="/home/bulk_update/send_welcome.csv">
      </div>

      <div style="margin:10px 0"></div>

      <label class="row">
        <input type="radio" name="csv_mode" value="manual"> Manual entry (up to 5 emails)
      </label>
      <div id="manual_wrap" style="display:none">
        <textarea name="manual_emails" rows="4" placeholder="e.g. alice@example.com, bob@example.com
(or one per line)"></textarea>
        <div class="small muted">Max 5 addresses. We’ll validate and create a temporary CSV for this run.</div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Options</legend>
      <label class="row"><input type="checkbox" name="send" value="1"> Send emails (untick = dry-run preview)</label>
      <div class="row">
        <label>Limit (0 = all): <input type="text" name="limit" value="0" class="small"></label>
        <label>Only Role: <input type="text" name="only_role" placeholder="e.g. subscriber" class="small"></label>
        <label>Campaign tag: <input type="text" name="campaign" placeholder="optional" class="small"></label>
      </div>
      <div class="row">
        <label>Batch size: <input type="text" name="batch_size" value="50" class="small"></label>
        <label>Batch sleep (sec): <input type="text" name="batch_sleep" value="2" class="small"></label>
      </div>
    </fieldset>

    <div class="row" style="margin-top:12px">
      <button type="submit">Launch Background Run</button>
      <a href="status.php"><button type="button">View Runs & Logs</button></a>
    </div>
  </form>

  <p class="muted" style="margin-top:16px">
    Results CSV and live stdout are stored under <code>/srv/admin-tools/wp-welcome-sender/_mailer-logs/</code>.
  </p>
  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var token = params.get('token');
      var fields = document.querySelectorAll('input[name="token"]');

      if (!fields.length) {
        return;
      }

    if (token) {
      fields.forEach(function(field) {
        field.value = token;
        field.type = 'hidden';
        field.required = false;
        var section = field.closest('fieldset');
        if (section) {
          section.style.display = 'none';
        } else {
          var label = field.closest('label');
          if (label) {
            label.style.display = 'none';
          }
        }
      });
        return;
      }

      fields.forEach(function(field) {
        var label = field.closest('label');
        if (!label || label.querySelector('.token-hint')) {
          return;
        }
        var hint = document.createElement('div');
        hint.className = 'token-hint';
        hint.textContent = 'Launch this tool from the CALM Admin Toolkit portal to auto-fill the access token.';
        hint.style.color = '#b91c1c';
        hint.style.fontSize = '12px';
        hint.style.marginTop = '6px';
        label.appendChild(hint);
      });
    })();
  </script>
    </div>
  </main>
</body>
</html>
